name: Test Installation Script

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  test:
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        test-case:
          - name: "default"
            args: ""
            expected-langs: "python elixir node"
            description: "é è¨­å®‰è£ (ç„¡åƒæ•¸)"

          - name: "custom-langs"
            args: "--langs=python,node"
            expected-langs: "python node"
            description: "è‡ªè¨‚èªžè¨€çµ„åˆ"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display test info
        run: |
          echo "ðŸ§ª æ¸¬è©¦æ¡ˆä¾‹: ${{ matrix.test-case.name }}"
          echo "ðŸ“ èªªæ˜Ž: ${{ matrix.test-case.description }}"
          echo "ðŸŽ¯ åƒæ•¸: ${{ matrix.test-case.args }}"
          echo "âœ… é æœŸèªžè¨€: ${{ matrix.test-case.expected-langs }}"

      - name: Cache mise installations
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/mise/installs
            ~/.local/share/mise/downloads
          key: mise-${{ runner.os }}-shared-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            mise-${{ runner.os }}-shared-

      - name: Verify Homebrew is installed
        run: |
          if command -v brew >/dev/null 2>&1; then
            echo "âœ“ Homebrew å·²å®‰è£"
            brew --version
          else
            echo "âœ— Homebrew æœªå®‰è£ï¼ˆä¸æ‡‰è©²ç™¼ç”Ÿåœ¨ GitHub Actionsï¼‰"
            exit 1
          fi

      - name: Run installation script
        run: |
          # çµ¦è…³æœ¬åŸ·è¡Œæ¬Šé™
          chmod +x setup.sh

          # åŸ·è¡Œå®‰è£è…³æœ¬ï¼ˆè‡ªå‹•å›žç­”æ‰€æœ‰æç¤ºç‚º Yesï¼‰
          # ä½¿ç”¨ yes å‘½ä»¤è‡ªå‹•æä¾› "y" å›žç­”
          yes | ./setup.sh ${{ matrix.test-case.args }} || true
        shell: bash

      - name: Verify tools installation
        run: |
          echo "ðŸ” é©—è­‰åŸºç¤Žå·¥å…·..."

          tools=("git" "mise" "rg" "fzf")

          for tool in "${tools[@]}"; do
            if command -v "$tool" >/dev/null 2>&1; then
              version=$($tool --version 2>&1 | head -n 1 || echo "ç„¡æ³•å–å¾—ç‰ˆæœ¬")
              echo "âœ“ $tool: $version"
            else
              echo "âœ— $tool æœªå®‰è£"
              exit 1
            fi
          done

      - name: Verify mise config
        run: |
          echo "ðŸ” é©—è­‰ mise è¨­å®šæª”..."

          config_file="$HOME/.config/mise/config.toml"

          if [[ -f "$config_file" ]]; then
            echo "âœ“ è¨­å®šæª”å­˜åœ¨: $config_file"
            echo ""
            echo "ðŸ“„ è¨­å®šæª”å…§å®¹:"
            cat "$config_file"
            echo ""
          else
            echo "âœ— è¨­å®šæª”ä¸å­˜åœ¨"
            exit 1
          fi

          # é©—è­‰é æœŸçš„èªžè¨€æ˜¯å¦åœ¨è¨­å®šæª”ä¸­
          expected_langs="${{ matrix.test-case.expected-langs }}"

          for lang in $expected_langs; do
            if grep -q "^$lang = " "$config_file"; then
              echo "âœ“ èªžè¨€ '$lang' å­˜åœ¨æ–¼è¨­å®šæª”ä¸­"
            else
              echo "âœ— èªžè¨€ '$lang' ä¸åœ¨è¨­å®šæª”ä¸­"
              exit 1
            fi
          done

      - name: Setup mise in current shell
        run: |
          echo "ðŸ”§ è¨­å®š mise ç’°å¢ƒ..."
          eval "$(mise activate bash)"
          echo "$HOME/.local/share/mise/shims" >> $GITHUB_PATH

      - name: Install languages with mise
        run: |
          echo "ðŸ“¦ é–‹å§‹å®‰è£èªžè¨€ç’°å¢ƒ..."

          # é¡¯ç¤ºå°‡è¦å®‰è£çš„å…§å®¹
          mise list || true

          # åŸ·è¡Œå®‰è£
          mise install -v

          echo ""
          echo "âœ“ å®‰è£å®Œæˆ"
        shell: bash

      - name: Verify language installations
        run: |
          echo "ðŸ” é©—è­‰èªžè¨€ç‰ˆæœ¬..."

          # é‡æ–°è¼‰å…¥ mise ç’°å¢ƒ
          eval "$(mise activate bash)"

          expected_langs="${{ matrix.test-case.expected-langs }}"

          for lang in $expected_langs; do
            echo ""
            echo "æª¢æŸ¥ $lang..."

            case $lang in
              python)
                if command -v python >/dev/null 2>&1; then
                  version=$(python --version)
                  echo "âœ“ Python: $version"
                else
                  echo "âœ— Python æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­"
                  exit 1
                fi
                ;;

              elixir)
                if command -v elixir >/dev/null 2>&1; then
                  version=$(elixir --version | grep "Elixir")
                  echo "âœ“ Elixir: $version"

                  # åŒæ™‚é©—è­‰ Erlang
                  if command -v erl >/dev/null 2>&1; then
                    erl_version=$(erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell)
                    echo "âœ“ Erlang/OTP: $erl_version"
                  fi
                else
                  echo "âœ— Elixir æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­"
                  exit 1
                fi
                ;;

              node)
                if command -v node >/dev/null 2>&1; then
                  version=$(node --version)
                  echo "âœ“ Node: $version"

                  # åŒæ™‚é©—è­‰ npm
                  if command -v npm >/dev/null 2>&1; then
                    npm_version=$(npm --version)
                    echo "âœ“ npm: $npm_version"
                  fi
                else
                  echo "âœ— Node æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­"
                  exit 1
                fi
                ;;

              rust)
                if command -v rustc >/dev/null 2>&1; then
                  version=$(rustc --version)
                  echo "âœ“ Rust: $version"
                else
                  echo "âœ— Rust æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­"
                  exit 1
                fi
                ;;

              ruby)
                if command -v ruby >/dev/null 2>&1; then
                  version=$(ruby --version)
                  echo "âœ“ Ruby: $version"
                else
                  echo "âœ— Ruby æœªå®‰è£æˆ–ä¸åœ¨ PATH ä¸­"
                  exit 1
                fi
                ;;
            esac
          done
        shell: bash

      - name: Test idempotency
        run: |
          echo "ðŸ”„ æ¸¬è©¦å†ªç­‰æ€§ï¼ˆé‡è¤‡åŸ·è¡Œï¼‰..."

          # ç¬¬äºŒæ¬¡åŸ·è¡Œæ‡‰è©²è·³éŽå·²å®‰è£çš„é …ç›®
          yes | ./setup.sh ${{ matrix.test-case.args }} || true

          echo "âœ“ å†ªç­‰æ€§æ¸¬è©¦é€šéŽ"
        shell: bash

      - name: Display mise info
        if: always()
        run: |
          echo "ðŸ“Š mise è³‡è¨Š"
          echo ""

          eval "$(mise activate bash)"

          echo "å·²å®‰è£çš„å·¥å…·:"
          mise list || true

          echo ""
          echo "mise è¨­å®š:"
          mise config || true

          echo ""
          echo "mise ç‹€æ…‹:"
          mise doctor || true
        shell: bash

      - name: Save logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.test-case.name }}
          path: |
            ~/.config/mise/
            ~/.local/share/mise/installs/
            ~/Library/Logs/Homebrew/
          retention-days: 7

  # æ¸¬è©¦æ‘˜è¦
  test-summary:
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Test Summary
        run: |
          echo "## æ¸¬è©¦çµæžœæ‘˜è¦ ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹å·²åŸ·è¡Œå®Œæˆã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é è¨­å®‰è£" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… è‡ªè¨‚èªžè¨€çµ„åˆ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å–®ä¸€èªžè¨€" >> $GITHUB_STEP_SUMMARY
